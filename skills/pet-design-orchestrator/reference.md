# 宠物设计编排器参考文档

## 技能与编排器对应关系

编排器调用的技能即为项目内技能目录名，对应关系如下：

| 编排器步骤/指令 | 技能目录 | 说明 |
|----------------|----------|------|
| 步骤 1：清晰度不足时增强 | `image-clarity-enhancement` | 检查清晰度，不足则用 Real-ESRGAN 等增强 |
| 小幅画质优化（按指令） | `image-quality-enhancement` | 仅做画质优化时单独调用 |
| 步骤 2：宠物抠图 | `pet-image-matting` | 输出透明背景宠物图 |
| 步骤 3：缺失补齐 | `pet-image-completion` | 抠图缺耳朵/身体时补齐 |
| 步骤 4：模板应用 | `template-application` | 图层合成：宠物 PNG + 背景图（无 AI） |
| 步骤 5：默认位置 | `pet-image-position-adjustment` | 已含在合成 layout 中 |
| 步骤 6：文字 | `text-style-adjustment` | 按需添加/编辑/删除文字 |
| 按指令：位置/大小 | `pet-image-position-adjustment` | 只改 layout 后重新跑合成脚本 |
| 按指令：文字 | `text-style-adjustment` | 仅做文字内容或样式调整 |
| 按指令：抠图不好 | `pet-image-matting` + 依赖步骤 | 重跑抠图→补齐→模板→位置→文字 |
| 按指令：小幅优化 | `image-quality-enhancement` | 仅做画质增强 |

## 会话目录与文件约定

| 文件名 | 说明 | 生成步骤 |
|--------|------|----------|
| `original.jpg` | 用户原始输入图像 | 用户上传 |
| `enhanced.jpg` | 清晰度增强后的图像 | 步骤 1（仅当清晰度不足时生成） |
| `extracted.png` | 抠图后的宠物图（透明背景） | 步骤 2 |
| `completed.png` | 补齐后的宠物图 | 步骤 3（仅当有缺失时生成） |
| `design.png` | 应用模板后的设计图 | 步骤 4 |
| `final.png` | 当前最新产品图 | 步骤 5/6 或按指令增量更新 |

- 步骤 1 若清晰度足够，可不生成 `enhanced.jpg`，后续步骤直接使用 `original.jpg`。
- 编排器根据**文件是否存在**判断该步是否已完成，从而决定跳过或执行。

## 指令解析与行为

### 位置或大小相关

- 关键词示例：向上/向下移动、居中、左上/右下角、放大/缩小、位置、大小等。
- 行为：**仅**使用 `pet-image-position-adjustment`，在最新产品图上做增量更新。
- 不重跑：抠图、补齐、清晰度增强、模板应用。

### 文字内容或样式相关

- 关键词示例：改文字、改字体、字号、颜色、文案等。
- 行为：**仅**使用 `text-style-adjustment`，在最新产品图上做增量更新。
- 不重跑：抠图、补齐、清晰度增强、模板应用、位置调整。

### 抠图不好 / 重抠

- 用户明确表示抠图不好、要重新抠图、边缘不好等。
- 行为：重跑 **pet-image-matting**，并重跑依赖步骤：**pet-image-completion**（若仍有缺失）→ **template-application** → **pet-image-position-adjustment** → **text-style-adjustment**。
- 不重跑：清晰度增强（除非用户明确要求重置）。

### 小幅优化 / 画质优化

- 用户仅要求画质优化、轻微增强、不改变构图等。
- 行为：**仅**使用 `image-quality-enhancement`。
- 不重跑：抠图、补齐、模板、位置、文字。

### 重置 / 从头开始

- 用户明确要求“从头开始”“全部重做”“重置”等。
- 行为：可按用户意图清除会话中部分或全部中间结果，再按默认工作流重新执行；清晰度与补齐仅在此时可被重跑。

## 约束摘要

- **不重跑已完成步骤**：除非用户明确要求重做或重置。
- **不重跑清晰度增强或补齐**：除非用户明确要求重置或重抠。
- **保留已有结果**：在已有产品图上只做增量更新。
- **输出**：始终返回**当前最新生成的产品图**路径（或 URL）。

## 错误与边界情况

| 情况 | 建议处理 |
|------|----------|
| 无原始图 | 提示用户先提供原始宠物图像 |
| 某技能调用失败 | 记录错误，若可能则返回上一步可用结果并提示 |
| 会话目录不存在 | 自动创建会话目录 |
| 用户指令含糊 | 优先解释为最小化更新（如仅位置或仅文字），必要时向用户确认 |

## 扩展说明

- 各技能的具体输入/输出与调用方式见 `skills/<技能目录名>/SKILL.md`。
- 若需新增步骤或新指令类型，应在 SKILL.md 的「默认工作流」「按指令执行」与本文档的「指令解析与行为」中同步更新。
